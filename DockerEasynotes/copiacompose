version: '3'
services:

#Balanceador web
 haproxy_web:
   build: ./ServicioHaproxyWeb
   ports:
     - '80:80'
   environment:
     - WEB_SERVICE_IP1=web1
     - WEB_SERVICE_IP2=web2
     - WEB_SERVICE_PORT1=8081
     - WEB_SERVICE_PORT2=8081

#Balanceador mail
 haproxymail:
   build: ./ServicioHaproxyMail
   ports:
     - '8025:8025'
   environment:
     - WEB_SERVICE_IP1=mail1
     - WEB_SERVICE_IP2=mail2
     - WEB_SERVICE_PORT1=8025
     - WEB_SERVICE_PORT2=8025

#Creamos los servidores web
 web1:
  build: ./ServicioWeb
   #Mount VOLUME FROM FILES SYSTEM
  volumes:
    - ./Files:/app/Files
  environment:
    - SPRING_DATASOURCE_URL=jdbc:mysql://db/easynotes
    - VALOR_MAIL_IP=haproxymail
 web2:
  build: ./ServicioWeb
  volumes:
    - ./Files:/app/Files
  
  environment:
    - SPRING_DATASOURCE_URL=jdbc:mysql://db/easynotes
    - VALOR_MAIL_IP=haproxymail

#Creamos los dos servicios de mail
 mail1:
   build: ./ServicioMail
 mail2:
   build: ./ServicioMail

#Load de DB 
 db:
  image: mysql:5.7
  ports:
     - '3306:3306'
  restart: always
   #ADD VOLUME FOR SQL PERSISTENCY
  volumes:
    - "./mysql:/var/lib/mysql"
  environment:
    MYSQL_USER: 'easynotes'
    MYSQL_PASSWORD: '1234'
    MYSQL_ROOT_PASSWORD: '1234'
    MYSQL_DATABASE: 'easynotes'
    MYSQL_ROOT_HOST: '%'
 

